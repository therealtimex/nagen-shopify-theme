{{ 'floating-buttons.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign show_buttons = section.settings.enable
  assign bottom_distance = section.settings.bottom_distance | default: 100
  assign right_distance = section.settings.right_distance | default: 20
  assign button_size = section.settings.button_size | default: 48
  assign button_size_mobile = section.settings.button_size_mobile | default: 44
  assign icon_size_percent = section.settings.icon_size | default: 50
  assign show_on_scroll = section.settings.show_on_scroll
  assign scroll_threshold = section.settings.scroll_threshold | default: 300
  assign mobile_toggle = section.settings.mobile_toggle
-%}

{%- if show_buttons and section.blocks.size > 0 -%}
  <style>
    .floating-buttons--{{ section.id }} {
      bottom: {{ bottom_distance }}px;
      right: {{ right_distance }}px;
    }
    
    .floating-buttons--{{ section.id }} .floating-button {
      width: {{ button_size }}px;
      height: {{ button_size }}px;
    }
    
    .floating-buttons--{{ section.id }} .floating-button__icon {
      width: {{ button_size | times: icon_size_percent | divided_by: 100 }}px;
      height: {{ button_size | times: icon_size_percent | divided_by: 100 }}px;
    }
    
    @media (max-width: 767px) {
      .floating-buttons--{{ section.id }} .floating-button {
        width: {{ button_size_mobile }}px;
        height: {{ button_size_mobile }}px;
      }
      
      .floating-buttons--{{ section.id }} .floating-button__icon {
        width: {{ button_size_mobile | times: icon_size_percent | divided_by: 100 }}px;
        height: {{ button_size_mobile | times: icon_size_percent | divided_by: 100 }}px;
      }
    }
    
    {%- for block in section.blocks -%}
      {%- if block.settings.bg_color != blank -%}
        .floating-button--{{ block.id }} {
          --floating-btn-bg: {{ block.settings.bg_color }};
        }
      {%- endif -%}
      {%- if block.settings.icon_color != blank -%}
        .floating-button--{{ block.id }} {
          --floating-btn-color: {{ block.settings.icon_color }};
        }
      {%- endif -%}
    {%- endfor -%}
  </style>

  <div 
    class="floating-buttons floating-buttons--{{ section.id }}{% if show_on_scroll %} floating-buttons--hidden{% endif %}{% if mobile_toggle %} floating-buttons--has-toggle{% endif %}"
    data-floating-buttons
    {% if show_on_scroll %}data-show-on-scroll="{{ scroll_threshold }}"{% endif %}
    {% if mobile_toggle %}data-mobile-toggle{% endif %}
  >
    {%- if mobile_toggle -%}
      <button type="button" class="floating-button floating-button--toggle" data-toggle-btn aria-label="Toggle menu" aria-expanded="false">
        <span class="floating-button__icon floating-button__icon--open">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
          </svg>
        </span>
        <span class="floating-button__icon floating-button__icon--close">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </span>
      </button>
    {%- endif -%}
    
    <div class="floating-buttons__list"{% if mobile_toggle %} data-buttons-list{% endif %}>
    {%- for block in section.blocks -%}
      {%- liquid
        assign button_type = block.settings.button_type
        assign tooltip = block.settings.tooltip
        assign link = block.settings.link
        assign page_link = block.settings.page_link
        assign icon_image = block.settings.icon_image
        assign icon_svg = block.settings.icon_svg
        assign open_new_tab = block.settings.open_new_tab
        assign enable_pulse = block.settings.enable_pulse
        assign ai_chat_sdk = block.settings.ai_chat_sdk
      -%}
      
      {%- case button_type -%}
        {%- when 'scroll_top' -%}
          <button 
            type="button"
            class="floating-button floating-button--scroll-top floating-button--{{ block.id }}{% if enable_pulse %} floating-button--pulse{% endif %}"
            onclick="window.scrollTo({ top: 0, behavior: 'smooth' })"
            aria-label="{{ tooltip | default: 'Scroll to top' }}"
            {{ block.shopify_attributes }}
          >
            <span class="floating-button__icon">
              {%- if icon_image != blank -%}
                <img src="{{ icon_image | image_url: width: 64 }}" alt="{{ tooltip | default: 'Icon' }}" loading="lazy">
              {%- elsif icon_svg != blank -%}
                {{ icon_svg }}
              {%- else -%}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <polyline points="18 15 12 9 6 15"></polyline>
                </svg>
              {%- endif -%}
            </span>
            {%- if tooltip != blank -%}
              <span class="floating-button__tooltip">{{ tooltip }}</span>
            {%- endif -%}
          </button>
          
        {%- when 'zalo' -%}
          <a 
            href="{{ link | default: '#' }}"
            class="floating-button floating-button--zalo floating-button--{{ block.id }}{% if enable_pulse %} floating-button--pulse{% endif %}"
            {% if open_new_tab %}target="_blank" rel="noopener"{% endif %}
            aria-label="{{ tooltip | default: 'Chat on Zalo' }}"
            {{ block.shopify_attributes }}
          >
            <span class="floating-button__icon">
              {%- if icon_image != blank -%}
                <img src="{{ icon_image | image_url: width: 64 }}" alt="{{ tooltip | default: 'Icon' }}" loading="lazy">
              {%- elsif icon_svg != blank -%}
                {{ icon_svg }}
              {%- else -%}
                <svg viewBox="0 0 48 48" fill="currentColor">
                  <path d="M24 4C12.954 4 4 12.954 4 24s8.954 20 20 20 20-8.954 20-20S35.046 4 24 4zm10.652 28.594c-.156.26-.442.406-.728.406-.13 0-.286-.052-.416-.104l-4.94-2.496c-.416-.208-.598-.728-.39-1.144.208-.416.728-.598 1.144-.39l3.406 1.716c-.39-1.04-.624-2.236-.624-3.51 0-4.472 2.99-8.086 6.682-8.086.52 0 .962.442.962.962 0 .52-.442.962-.962.962-2.652 0-4.758 2.756-4.758 6.162 0 1.742.494 3.328 1.274 4.524.182.286.156.65-.026.936-.182.286-.468.442-.78.442-.182 0-.364-.052-.52-.156l.676-.324zM12.582 33c-.52 0-.962-.442-.962-.962v-8.606c0-.52.442-.962.962-.962.52 0 .962.442.962.962v7.644h4.628c.52 0 .962.442.962.962s-.442.962-.962.962h-5.59zm10.4 0c-.52 0-.962-.442-.962-.962v-4.992c0-.78-.624-1.404-1.404-1.404-.52 0-.962-.442-.962-.962 0-.52.442-.962.962-.962 1.82 0 3.328 1.508 3.328 3.328v4.992c0 .52-.442.962-.962.962z"/>
                </svg>
              {%- endif -%}
            </span>
            {%- if tooltip != blank -%}
              <span class="floating-button__tooltip">{{ tooltip }}</span>
            {%- endif -%}
          </a>
          
        {%- when 'messenger' -%}
          <a 
            href="{{ link | default: '#' }}"
            class="floating-button floating-button--messenger floating-button--{{ block.id }}{% if enable_pulse %} floating-button--pulse{% endif %}"
            {% if open_new_tab %}target="_blank" rel="noopener"{% endif %}
            aria-label="{{ tooltip | default: 'Chat on Messenger' }}"
            {{ block.shopify_attributes }}
          >
            <span class="floating-button__icon">
              {%- if icon_image != blank -%}
                <img src="{{ icon_image | image_url: width: 64 }}" alt="{{ tooltip | default: 'Icon' }}" loading="lazy">
              {%- elsif icon_svg != blank -%}
                {{ icon_svg }}
              {%- else -%}
                <svg viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 2C6.477 2 2 6.145 2 11.243c0 2.908 1.438 5.503 3.686 7.2V22l3.388-1.862c.903.251 1.86.386 2.855.386h.071c5.523 0 10-4.145 10-9.243C22 6.145 17.523 2 12 2zm1.004 12.424l-2.546-2.716-4.97 2.716 5.467-5.808 2.609 2.716 4.907-2.716-5.467 5.808z"/>
                </svg>
              {%- endif -%}
            </span>
            {%- if tooltip != blank -%}
              <span class="floating-button__tooltip">{{ tooltip }}</span>
            {%- endif -%}
          </a>
          
        {%- when 'phone' -%}
          {%- assign phone_number = link | remove: ' ' | remove: '-' | remove: '.' | remove: '(' | remove: ')' -%}
          <a 
            href="tel:{{ phone_number }}"
            class="floating-button floating-button--phone floating-button--{{ block.id }}{% if enable_pulse %} floating-button--pulse{% endif %}"
            aria-label="{{ tooltip | default: 'Call us' }}"
            {{ block.shopify_attributes }}
          >
            <span class="floating-button__icon">
              {%- if icon_image != blank -%}
                <img src="{{ icon_image | image_url: width: 64 }}" alt="{{ tooltip | default: 'Icon' }}" loading="lazy">
              {%- elsif icon_svg != blank -%}
                {{ icon_svg }}
              {%- else -%}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                </svg>
              {%- endif -%}
            </span>
            {%- if tooltip != blank -%}
              <span class="floating-button__tooltip">{{ tooltip }}</span>
            {%- endif -%}
          </a>
          
        {%- when 'custom' -%}
          {%- liquid
            if page_link != blank
              assign custom_url = page_link
            elsif link != blank
              assign custom_url = link
            else
              assign custom_url = '#'
            endif
          -%}
          <a 
            href="{{ custom_url }}"
            class="floating-button floating-button--custom floating-button--{{ block.id }}{% if enable_pulse %} floating-button--pulse{% endif %}"
            {% if open_new_tab %}target="_blank" rel="noopener"{% endif %}
            aria-label="{{ tooltip | default: 'Link' }}"
            {{ block.shopify_attributes }}
          >
            <span class="floating-button__icon">
              {%- if icon_image != blank -%}
                <img src="{{ icon_image | image_url: width: 64 }}" alt="{{ tooltip | default: 'Icon' }}" loading="lazy">
              {%- elsif icon_svg != blank -%}
                {{ icon_svg }}
              {%- else -%}
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                  <polyline points="15 3 21 3 21 9"></polyline>
                  <line x1="10" y1="14" x2="21" y2="3"></line>
                </svg>
              {%- endif -%}
            </span>
            {%- if tooltip != blank -%}
              <span class="floating-button__tooltip">{{ tooltip }}</span>
            {%- endif -%}
          </a>
          
        {%- when 'ai_chat' -%}
          {%- comment -%} AI Chat SDK renders its own UI, we just output the script {%- endcomment -%}
          {%- if ai_chat_sdk != blank -%}
            {{ ai_chat_sdk }}
          {%- endif -%}
      {%- endcase -%}
    {%- endfor -%}
    </div>{%- comment -%} End .floating-buttons__list {%- endcomment -%}
  </div>

  <script>
    (function() {
      const container = document.querySelector('[data-floating-buttons]');
      if (!container) return;
      
      // Show on scroll functionality
      const showOnScroll = container.dataset.showOnScroll;
      if (showOnScroll) {
        const threshold = parseInt(showOnScroll, 10);
        
        function handleScroll() {
          if (window.scrollY > threshold) {
            container.classList.remove('floating-buttons--hidden');
          } else {
            container.classList.add('floating-buttons--hidden');
          }
        }
        
        window.addEventListener('scroll', handleScroll, { passive: true });
        handleScroll();
      }
      
      // Mobile toggle functionality
      const hasMobileToggle = container.hasAttribute('data-mobile-toggle');
      if (hasMobileToggle) {
        const toggleBtn = container.querySelector('[data-toggle-btn]');
        const buttonsList = container.querySelector('[data-buttons-list]');
        
        if (toggleBtn && buttonsList) {
          toggleBtn.addEventListener('click', function() {
            const isExpanded = toggleBtn.getAttribute('aria-expanded') === 'true';
            toggleBtn.setAttribute('aria-expanded', !isExpanded);
            container.classList.toggle('floating-buttons--expanded', !isExpanded);
          });
          
          // Close when clicking outside on mobile
          document.addEventListener('click', function(e) {
            if (window.innerWidth <= 767 && !container.contains(e.target)) {
              toggleBtn.setAttribute('aria-expanded', 'false');
              container.classList.remove('floating-buttons--expanded');
            }
          });
        }
      }
    })();
  </script>
{%- endif -%}

{% schema %}
{
  "name": "Floating Buttons",
  "class": "floating-buttons-section",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable",
      "label": "Enable floating buttons",
      "default": true
    },
    {
      "type": "header",
      "content": "Position"
    },
    {
      "type": "range",
      "id": "bottom_distance",
      "label": "Distance from bottom (px)",
      "min": 20,
      "max": 300,
      "step": 10,
      "default": 100,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "right_distance",
      "label": "Distance from right (px)",
      "min": 10,
      "max": 100,
      "step": 5,
      "default": 20,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "range",
      "id": "button_size",
      "label": "Button size - Desktop (px)",
      "min": 36,
      "max": 64,
      "step": 4,
      "default": 48,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "button_size_mobile",
      "label": "Button size - Mobile (px)",
      "min": 32,
      "max": 64,
      "step": 4,
      "default": 44,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "icon_size",
      "label": "Icon size (%)",
      "min": 40,
      "max": 100,
      "step": 5,
      "default": 50,
      "unit": "%",
      "info": "Size of icon relative to button size"
    },
    {
      "type": "header",
      "content": "Behavior"
    },
    {
      "type": "checkbox",
      "id": "show_on_scroll",
      "label": "Show only after scrolling",
      "default": false
    },
    {
      "type": "range",
      "id": "scroll_threshold",
      "label": "Scroll threshold (px)",
      "min": 100,
      "max": 1000,
      "step": 50,
      "default": 300,
      "unit": "px",
      "info": "Show buttons after scrolling this distance"
    },
    {
      "type": "header",
      "content": "Mobile Settings"
    },
    {
      "type": "checkbox",
      "id": "mobile_toggle",
      "label": "Collapse buttons on mobile",
      "default": false,
      "info": "Show a toggle button to expand/collapse the buttons list on mobile. Note: AI Chat SDK renders independently and won't be affected."
    }
  ],
  "blocks": [
    {
      "type": "button",
      "name": "Button",
      "settings": [
        {
          "type": "select",
          "id": "button_type",
          "label": "Button type",
          "options": [
            { "value": "custom", "label": "Custom Link" },
            { "value": "zalo", "label": "Zalo" },
            { "value": "messenger", "label": "Messenger" },
            { "value": "phone", "label": "Phone Call" },
            { "value": "scroll_top", "label": "Scroll to Top" },
            { "value": "ai_chat", "label": "AI Chat (SDK)" }
          ],
          "default": "custom"
        },
        {
          "type": "text",
          "id": "tooltip",
          "label": "Tooltip text",
          "info": "Text shown on hover"
        },
        {
          "type": "text",
          "id": "link",
          "label": "Link / Phone Number",
          "info": "For Zalo: use zalo.me link. For Messenger: use m.me link. For Phone: enter phone number."
        },
        {
          "type": "url",
          "id": "page_link",
          "label": "Or select a page",
          "info": "For Custom Link: select a store page. This overrides the text link above."
        },
        {
          "type": "liquid",
          "id": "ai_chat_sdk",
          "label": "AI Chat SDK Script",
          "info": "For AI Chat type: paste the JavaScript SDK script here. It will be rendered alongside the button."
        },
        {
          "type": "checkbox",
          "id": "open_new_tab",
          "label": "Open in new tab",
          "default": true
        },
        {
          "type": "header",
          "content": "Styling"
        },
        {
          "type": "color",
          "id": "bg_color",
          "label": "Background color",
          "info": "Leave blank to use default platform color"
        },
        {
          "type": "color",
          "id": "icon_color",
          "label": "Icon color",
          "default": "#ffffff"
        },
        {
          "type": "image_picker",
          "id": "icon_image",
          "label": "Custom icon (Image)",
          "info": "Upload an icon image. Recommended: PNG with transparent background."
        },
        {
          "type": "liquid",
          "id": "icon_svg",
          "label": "Custom icon (SVG)",
          "info": "Or paste SVG code here. Image takes priority over SVG."
        },
        {
          "type": "checkbox",
          "id": "enable_pulse",
          "label": "Enable pulse animation",
          "default": false,
          "info": "Add attention-grabbing pulse effect"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Floating Buttons",
      "blocks": [
        {
          "type": "button",
          "settings": {
            "button_type": "scroll_top",
            "tooltip": "Về đầu trang"
          }
        }
      ]
    }
  ]
}
{% endschema %}
