{%- style -%}
  #shopify-section-{{ section.id }} {
    --slideshow-width: {{ section.settings.slideshow_width }}%;
    --gap: {{ section.settings.gap }}px;
    --border-radius: {{ section.settings.border_radius }}px;
    --desktop-height: {{ section.settings.desktop_height }}px;
    --mobile-aspect-ratio: {{ section.settings.mobile_aspect_ratio }};
  }

  .slideshow-split__container {
    display: flex;
    gap: var(--gap);
    align-items: stretch;
    width: 100%;
  }

  .slideshow-split__main {
    width: var(--slideshow-width);
    flex-shrink: 0;
    position: relative;
    border-radius: var(--border-radius);
    overflow: hidden;
    height: var(--desktop-height) !important;
  }

  .slideshow-split__static {
    width: calc(100% - var(--slideshow-width) - var(--gap));
    display: flex;
    flex-direction: column;
    gap: var(--gap);
    flex-grow: 1;
    height: var(--desktop-height) !important;
    border-radius: var(--border-radius);
    overflow: hidden;
  }

  .slideshow-split__static-item {
    flex: 1;
    position: relative;
    border-radius: var(--border-radius);
    overflow: hidden;
    height: 100%;
  }

  .slideshow-split__image-link {
    display: block;
    width: 100%;
    height: 100%;
  }

  .slideshow-split__image-link img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Swiper Customization */
  .slideshow-split .swiper {
    width: 100% !important;
    height: 100% !important;
    position: relative;
    border-radius: inherit;
  }

  .slideshow-split .swiper-wrapper {
    height: 100% !important;
  }

  .slideshow-split .swiper-slide {
    height: 100% !important;
    border-radius: inherit;
    overflow: hidden;
  }

  .slideshow-split .swiper-pagination {
    bottom: 20px !important;
    left: 0 !important;
    width: 100% !important;
    z-index: 20;
    display: flex !important;
    justify-content: center !important;
    gap: 8px;
    transform: none !important; /* Remove translate centering */
    pointer-events: none; /* Let clicks pass through if not on dots */
    position: absolute !important; /* Force absolute positioning on Desktop too */
  }

  .slideshow-split .swiper-pagination-bullet {
    background: #fff !important;
    opacity: 0.6 !important;
    width: 10px !important;
    height: 10px !important;
    margin: 0 !important;
    transition: all 0.3s ease;
    border-radius: 50%;
    cursor: pointer;
    display: block !important;
    pointer-events: auto; /* Re-enable clicks */
    box-shadow: 0 1px 3px rgba(0,0,0,0.3); /* Add shadow for visibility on light bg */
  }

  .slideshow-split .swiper-pagination-bullet-active {
    background: var(--primary, #21395d) !important;
    opacity: 1 !important;
    width: 25px !important;
    border-radius: 5px !important;
  }

  .slideshow-split .swiper-arrow {
    position: absolute;
    top: 50%;
    left: 0;
    width: 100%;
    transform: translateY(-50%);
    z-index: 60;
    pointer-events: none;
    display: flex;
    justify-content: space-between;
    padding: 0 20px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  /* Show arrows only when hovering the active carousel area */
  .slideshow-split__main:hover .swiper-arrow,
  .slideshow-split__static:hover .swiper-arrow {
    opacity: 1;
    visibility: visible;
  }

  .slideshow-split .swiper-button-next,
  .slideshow-split .swiper-button-prev {
    color: #fff;
    background: rgba(0,0,0,0.3);
    width: 44px;
    height: 44px;
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
    position: static; /* Reset absolute positioning since parent handles it */
    margin: 0; /* Reset margins */
    background: rgba(0,0,0,0.6);
    pointer-events: auto;
  }

  .slideshow-split .swiper-button-next:after,
  .slideshow-split .swiper-button-prev:after {
    display: none; /* Hide default Swiper font icons */
    content: none;
  }

  @media (max-width: 991px) {
    .slideshow-split .swiper-arrow {
      opacity: 1;
      visibility: visible;
      padding: 0 12px;
    }

    .slideshow-split__main,
    .slideshow-split__static {
      height: auto !important;
    }
    .slideshow-split__container {
      flex-direction: column;
    }
    .slideshow-split__main,
    .slideshow-split__static {
      width: 100%;
    }
    .slideshow-split__static {
      flex-direction: row;
    }
    .slideshow-split__main {
      aspect-ratio: 16 / 8;
    }
    /* Fix mobile height for static side - allow vertical growth */
    .slideshow-split__static-item {
      aspect-ratio: auto;
      min-aspect-ratio: 16 / 8;
      height: auto !important;
    }
    .slideshow-split .swiper-slide {
      height: auto !important; /* Allow slides to grow on mobile */
    }

    /* Mobile Video Fix: Force square/portrait ratio to prevent collapse */
    .slideshow-split__static-item--video {
      aspect-ratio: var(--mobile-aspect-ratio) !important;
      min-height: 0;
      height: auto !important;
      display: block;
      width: 100%;
      object-fit: cover;
      border-radius: var(--border-radius); /* Apply radius */
      overflow: hidden; /* Clip corners */
      isolation: isolate; /* Force stacking context for Safari radius */
      transform: translateZ(0); /* Force radius hardware accel */
    }
    /* Ensure video facade respects the new aspect ratio logic */
     .slideshow-split__video-container {
      height: 100% !important;
      border-radius: inherit; /* Inherit from item */
      overflow: hidden;
      isolation: isolate;
    }
    
    .slideshow-split .swiper-pagination {
      bottom: 15px !important; /* safe spacing */
      z-index: 50 !important; /* Ensure on top of everything */
      position: absolute !important;
    }
  }

  @media (max-width: 575px) {
    .slideshow-split__static {
      flex-direction: column;
    }
  }
  .slideshow-split__video-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .slideshow-split__video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

{%- endstyle -%}

{% render 'section-style' %}

<section class="section section--flush shopify-section--slideshow slideshow-split {{ section.settings.class }}" data-section-id="{{ section.id }}">
  <div class="shopify-container">
    <div class="slideshow-split__container">
      
      {%- assign slide_blocks = section.blocks | where: 'type', 'slide' -%}
      {%- if slide_blocks.size > 0 -%}
        <div class="slideshow-split__main">
          <div id="swiper-{{ section.id }}" class="slideshow swiper ap-object-loaded" 
            data-autoplay="{{ section.settings.autoplay }}"
            data-speed="{{ section.settings.autoplay_speed | times: 1000 }}"
            data-navigation="{{ section.settings.show_navigation }}"
            data-pagination="{{ section.settings.show_pagination }}">
            
            <div class="swiper-wrapper">
              {%- for block in slide_blocks -%}
                <div class="swiper-slide" {{ block.shopify_attributes }}>
                  {%- if block.settings.video != blank -%}
                    <div class="slideshow-split__video-container">
                      {%- liquid
                        assign video_class = 'slideshow-split__video'
                        if section.settings.autoplay_video == false
                          assign video_class = video_class | append: ' slideshow-split__video--controls'
                        endif
                      -%}
                      {{ block.settings.video | video_tag: 
                        image_size: '2000x', 
                        autoplay: section.settings.autoplay_video, 
                        loop: section.settings.autoplay_video, 
                        muted: section.settings.autoplay_video, 
                        controls: block.settings.show_controls,
                        class: video_class
                      }}
                    </div>
                  {%- elsif block.settings.video_url != blank -%}
                    <div class="slideshow-split__video-container">
                      {%- if block.settings.video_url.type == 'youtube' -%}
                        <iframe id="yt-player-{{ block.id }}" src="https://www.youtube.com/embed/{{ block.settings.video_url.id }}?enablejsapi=1&autoplay=0&mute=0&controls=1&playsinline=1&rel=0&modestbranding=1&origin={{ shop.url | url_escape }}" class="slideshow-split__video" frameborder="0" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>
                      {%- elsif block.settings.video_url.type == 'vimeo' -%}
                         <iframe src="https://player.vimeo.com/video/{{ block.settings.video_url.id }}?autoplay={% if section.settings.autoplay_video %}1{% else %}0{% endif %}&muted={% if section.settings.autoplay_video %}1{% else %}0{% endif %}&loop={% if section.settings.autoplay_video %}1{% else %}0{% endif %}&background=0" class="slideshow-split__video" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
                      {%- endif -%}
                    </div>
                  {%- else -%}
                    {%- if block.settings.link != blank -%}
                      <a href="{{ block.settings.link }}" class="slideshow-split__image-link">
                    {%- else -%}
                      <div class="slideshow-split__image-link">
                    {%- endif -%}
                      
                      {%- if block.settings.image != blank -%}
                        {{ block.settings.image | image_url: width: 2000 | image_tag: loading: 'lazy', class: 'slideshow-split__image' }}
                      {%- else -%}
                        {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      {%- endif -%}

                    {%- if block.settings.link != blank -%}
                      </a>
                    {%- else -%}
                      </div>
                    {%- endif -%}
                  {%- endif -%}
                </div>
              {%- endfor -%}
            </div>

            {%- if section.settings.show_pagination -%}
              <div class="swiper-pagination swiper-pagination_{{ section.id }}"></div>
            {%- endif -%}

            {%- if section.settings.show_navigation -%}
              <div class="swiper-arrow">
                <div class="swiper-button-prev swiper-button-prev_{{ section.id }}">
                  <svg width="11" height="10" viewBox="0 0 11 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0.757812 5.34375L4.32031 9.09375C4.50781 9.28125 4.73438 9.375 5 9.375C5.25 9.375 5.46875 9.28906 5.65625 9.11719C5.84375 8.94531 5.9375 8.72656 5.9375 8.46094C5.9375 8.19531 5.85156 7.96875 5.67969 7.78125L3.61719 5.625H10.0625C10.3281 5.625 10.5547 5.53906 10.7422 5.36719C10.9141 5.17969 11 4.95312 11 4.6875C11 4.42188 10.9141 4.20312 10.7422 4.03125C10.5547 3.84375 10.3281 3.75 10.0625 3.75H3.61719L5.67969 1.59375C5.85156 1.40625 5.9375 1.17969 5.9375 0.914062C5.9375 0.648438 5.84375 0.429688 5.65625 0.257812C5.46875 0.0859375 5.24219 0 4.97656 0C4.71094 0 4.49219 0.09375 4.32031 0.28125L0.757812 4.03125C0.585938 4.21875 0.5 4.4375 0.5 4.6875C0.5 4.9375 0.585938 5.15625 0.757812 5.34375Z" fill="currentColor" /></svg>
                </div>
                <div class="swiper-button-next swiper-button-next_{{ section.id }}">
                  <svg width="11" height="10" viewBox="0 0 11 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.2422 5.34375L6.67969 9.09375C6.49219 9.28125 6.26562 9.375 6 9.375C5.75 9.375 5.53125 9.28906 5.34375 9.11719C5.15625 8.94531 5.0625 8.72656 5.0625 8.46094C5.0625 8.19531 5.14844 7.96875 5.32031 7.78125L7.38281 5.625H0.9375C0.671875 5.625 0.445312 5.53906 0.257812 5.36719C0.0859375 5.17969 0 4.95312 0 4.6875C0 4.42188 0.0859375 4.20312 0.257812 4.03125C0.445312 3.84375 0.671875 3.75 0.9375 3.75H7.38281L5.32031 1.59375C5.14844 1.40625 5.0625 1.17969 5.0625 0.914062C5.0625 0.648438 5.15625 0.429688 5.34375 0.257812C5.53125 0.0859375 5.75781 0 6.02344 0C6.28906 0 6.50781 0.09375 6.67969 0.28125L10.2422 4.03125C10.4141 4.21875 10.5 4.4375 10.5 4.6875C10.5 4.9375 10.4141 5.15625 10.2422 5.34375Z" fill="currentColor"/></svg>
                </div>
              </div>
            {%- endif -%}
          </div>
        </div>
      {%- endif -%}

      {%- assign static_blocks = section.blocks | where: 'type', 'static_banner' -%}
      {%- if static_blocks.size > 0 -%}
        <div class="slideshow-split__static">
          
          {%- if section.settings.right_mode == 'carousel' -%}
            <!-- Carousel Mode (Right Side) -->
            <div id="swiper-right-{{ section.id }}" class="slideshow swiper ap-object-loaded" 
              data-autoplay="{{ section.settings.autoplay }}"
              data-speed="{{ section.settings.autoplay_speed | times: 1000 }}"
              data-navigation="{{ section.settings.show_navigation }}"
              data-pagination="{{ section.settings.show_pagination }}"
              data-direction="{{ section.settings.right_slide_direction }}">
              
              <div class="swiper-wrapper">
                {%- for block in static_blocks -%}
                  {%- liquid
                    assign has_video = false
                    if block.settings.video != blank or block.settings.video_url != blank
                      assign has_video = true
                    endif
                  -%}
                  <div class="swiper-slide {% if has_video %}slideshow-split__static-item--video{% endif %}" {{ block.shopify_attributes }}>
                    {%- render 'slideshow-split-content', block: block, autoplay_video: section.settings.autoplay_video -%}
                  </div>
                {%- endfor -%}
              </div>

              {%- if section.settings.show_pagination -%}
                <div class="swiper-pagination swiper-pagination-right_{{ section.id }}"></div>
              {%- endif -%}

              {%- if section.settings.show_navigation -%}
                <div class="swiper-arrow">
                  <div class="swiper-button-prev swiper-button-prev-right_{{ section.id }}">
                    <svg width="11" height="10" viewBox="0 0 11 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0.757812 5.34375L4.32031 9.09375C4.50781 9.28125 4.73438 9.375 5 9.375C5.25 9.375 5.46875 9.28906 5.65625 9.11719C5.84375 8.94531 5.9375 8.72656 5.9375 8.46094C5.9375 8.19531 5.85156 7.96875 5.67969 7.78125L3.61719 5.625H10.0625C10.3281 5.625 10.5547 5.53906 10.7422 5.36719C10.9141 5.17969 11 4.95312 11 4.6875C11 4.42188 10.9141 4.20312 10.7422 4.03125C10.5547 3.84375 10.3281 3.75 10.0625 3.75H3.61719L5.67969 1.59375C5.85156 1.40625 5.9375 1.17969 5.9375 0.914062C5.9375 0.648438 5.84375 0.429688 5.65625 0.257812C5.46875 0.0859375 5.24219 0 4.97656 0C4.71094 0 4.49219 0.09375 4.32031 0.28125L0.757812 4.03125C0.585938 4.21875 0.5 4.4375 0.5 4.6875C0.5 4.9375 0.585938 5.15625 0.757812 5.34375Z" fill="currentColor" /></svg>
                  </div>
                  <div class="swiper-button-next swiper-button-next-right_{{ section.id }}">
                    <svg width="11" height="10" viewBox="0 0 11 10" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.2422 5.34375L6.67969 9.09375C6.49219 9.28125 6.26562 9.375 6 9.375C5.75 9.375 5.53125 9.28906 5.34375 9.11719C5.15625 8.94531 5.0625 8.72656 5.0625 8.46094C5.0625 8.19531 5.14844 7.96875 5.32031 7.78125L7.38281 5.625H0.9375C0.671875 5.625 0.445312 5.53906 0.257812 5.36719C0.0859375 5.17969 0 4.95312 0 4.6875C0 4.42188 0.0859375 4.20312 0.257812 4.03125C0.445312 3.84375 0.671875 3.75 0.9375 3.75H7.38281L5.32031 1.59375C5.14844 1.40625 5.0625 1.17969 5.0625 0.914062C5.0625 0.648438 5.15625 0.429688 5.34375 0.257812C5.53125 0.0859375 5.75781 0 6.02344 0C6.28906 0 6.50781 0.09375 6.67969 0.28125L10.2422 4.03125C10.4141 4.21875 10.5 4.4375 10.5 4.6875C10.5 4.9375 10.4141 5.15625 10.2422 5.34375Z" fill="currentColor"/></svg>
                  </div>
                </div>
              {%- endif -%}
            </div>

          {%- else -%}
            <!-- Stacked Mode (Legacy 2 items) -->
            {%- for block in static_blocks limit: 2 -%}
              {%- liquid
                assign has_video = false
                if block.settings.video != blank or block.settings.video_url != blank
                  assign has_video = true
                endif
              -%}
              <div class="slideshow-split__static-item {% if has_video %}slideshow-split__static-item--video{% endif %}" {{ block.shopify_attributes }}>
                {%- render 'slideshow-split-content', block: block, autoplay_video: section.settings.autoplay_video -%}
              </div>
            {%- endfor -%}
          {%- endif -%}

        </div>
      {%- endif -%}

    </div>
  </div>
</section>

{%- capture content_snippet -%}
{%- endcapture -%}

<script>
document.addEventListener('DOMContentLoaded', function() {
  // ===========================
  // CONFIGURATION
  // ===========================
  const DEBUG = false;
  const log = (...args) => DEBUG && console.log('[VideoSlideshow]', ...args);

  const SECTION_ID = '{{ section.id }}';
  const root = document.querySelector(`#shopify-section-${SECTION_ID}`);
  if (!root) return;

  // ===========================
  // VIDEO MANAGER CLASS
  // ===========================
  /**
   * Centralized video controller for the slideshow.
   * Enforces single-video policy and manages carousel autoplay.
   */
  class VideoManager {
    constructor() {
      this.swipers = { main: null, right: null };
      this.ytPlayers = new Map();        // id -> YT.Player
      this.html5Videos = new Set();       // Set of video elements
      this.currentlyPlaying = null;       // { type: 'youtube'|'html5', id: string }
      this.ytApiReady = false;
    }

    // --- Registration ---
    registerSwiper(name, instance) {
      this.swipers[name] = instance;
      log(`Registered swiper: ${name}`);
    }

    registerYouTubePlayer(id, player) {
      this.ytPlayers.set(id, player);
      log(`Registered YouTube player: ${id}`);
    }

    registerHTML5Video(video) {
      this.html5Videos.add(video);
      this._attachHTML5Listeners(video);
      log(`Registered HTML5 video: ${video.src?.slice(-30) || 'unknown'}`);
    }

    // --- Playback Control ---
    /**
     * Notify that a video started playing.
     * Immediately pauses all other videos and stops carousel autoplay.
     */
    onVideoPlay(type, id) {
      log(`Video playing: ${type}/${id}`);
      
      // Pause all OTHER videos immediately
      this._pauseAllExcept(type, id);
      
      // Update current state
      this.currentlyPlaying = { type, id };
      
      // Stop all carousel autoplay
      this.pauseCarousels();
    }

    /**
     * Notify that a video stopped playing.
     * Resumes carousel if nothing else is playing.
     */
    onVideoStop(type, id) {
      log(`Video stopped: ${type}/${id}`);
      
      // Clear current if it matches
      if (this.currentlyPlaying?.type === type && this.currentlyPlaying?.id === id) {
        this.currentlyPlaying = null;
      }
      
      // Check if anything else is still playing
      if (!this.isAnyVideoPlaying()) {
        this.resumeCarousels();
      }
    }

    /**
     * Force pause all videos. Called during slide transitions.
     */
    pauseAll() {
      log('Pausing all videos');
      
      // Pause all YouTube players
      this.ytPlayers.forEach((player, id) => {
        this._safeYTPause(player, id);
      });
      
      // Pause all HTML5 videos
      this.html5Videos.forEach(video => {
        if (!video.paused) {
          video.pause();
        }
      });
      
      this.currentlyPlaying = null;
    }

    // --- Carousel Control ---
    pauseCarousels() {
      Object.values(this.swipers).forEach(swiper => {
        if (swiper?.autoplay?.running) {
          swiper.autoplay.stop();
          log('Carousel autoplay stopped');
        }
      });
    }

    resumeCarousels() {
      Object.entries(this.swipers).forEach(([name, swiper]) => {
        if (!swiper) return;
        
        const shouldAutoplay = swiper.el?.dataset?.autoplay === 'true';
        if (shouldAutoplay && !swiper.autoplay.running) {
          swiper.autoplay.start();
          log(`Carousel ${name} autoplay resumed`);
        }
      });
    }

    // --- Query ---
    isAnyVideoPlaying() {
      // Check HTML5 videos
      for (const video of this.html5Videos) {
        if (!video.paused) {
          return true;
        }
      }
      
      // Check YouTube players
      if (this.ytApiReady) {
        for (const [id, player] of this.ytPlayers) {
          const state = this._safeYTGetState(player, id);
          if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.BUFFERING) {
            return true;
          }
        }
      }
      
      return false;
    }

    // --- Private Helpers ---
    _pauseAllExcept(exceptType, exceptId) {
      // Pause all YouTube except the one playing
      this.ytPlayers.forEach((player, id) => {
        if (exceptType === 'youtube' && id === exceptId) return;
        this._safeYTPause(player, id);
      });
      
      // Pause all HTML5 except the one playing
      this.html5Videos.forEach(video => {
        const videoId = video.dataset.videoId || video.src;
        if (exceptType === 'html5' && videoId === exceptId) return;
        if (!video.paused) {
          video.pause();
        }
      });
    }

    _attachHTML5Listeners(video) {
      const videoId = video.dataset.videoId || video.src || `html5-${this.html5Videos.size}`;
      
      video.addEventListener('play', () => {
        this.onVideoPlay('html5', videoId);
      });
      
      video.addEventListener('pause', () => {
        this.onVideoStop('html5', videoId);
      });
      
      video.addEventListener('ended', () => {
        this.onVideoStop('html5', videoId);
      });
    }

    _safeYTGetState(player, id) {
      try {
        if (typeof player?.getPlayerState === 'function') {
          return player.getPlayerState();
        }
      } catch (e) {
        log(`Failed to get state for ${id}:`, e.message);
      }
      return null;
    }

    _safeYTPause(player, id) {
      try {
        if (typeof player?.pauseVideo === 'function') {
          const state = this._safeYTGetState(player, id);
          if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.BUFFERING) {
            player.pauseVideo();
            log(`Paused YouTube: ${id}`);
          }
        }
      } catch (e) {
        log(`Failed to pause ${id}:`, e.message);
      }
    }
  }

  // Create singleton instance for this section
  const videoManager = new VideoManager();

  // ===========================
  // YOUTUBE API SETUP
  // ===========================
  const YT_IFRAME_SELECTOR = 'iframe[src*="youtube"][id]';

  function initYouTubePlayers() {
    if (!window.YT?.Player) {
      log('YT API not ready');
      return;
    }
    
    videoManager.ytApiReady = true;
    
    const iframes = root.querySelectorAll(YT_IFRAME_SELECTOR);
    log(`Found ${iframes.length} YouTube iframe(s)`);
    
    iframes.forEach(iframe => {
      if (!iframe.id || videoManager.ytPlayers.has(iframe.id)) return;
      
      try {
        const player = new YT.Player(iframe.id, {
          events: {
            onReady: (e) => {
              log(`YouTube ready: ${iframe.id}`);
              videoManager.registerYouTubePlayer(iframe.id, e.target);
            },
            onStateChange: (e) => {
              const state = e.data;
              log(`YouTube ${iframe.id} state: ${state}`);
              
              if (state === YT.PlayerState.PLAYING || state === YT.PlayerState.BUFFERING) {
                videoManager.onVideoPlay('youtube', iframe.id);
              } else if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.ENDED) {
                videoManager.onVideoStop('youtube', iframe.id);
              }
            },
            onError: (e) => {
              console.error(`YouTube error (${iframe.id}):`, e.data);
            }
          }
        });
      } catch (e) {
        console.error(`Failed to init YouTube player ${iframe.id}:`, e);
      }
    });
  }

  // Load YouTube API if needed
  function loadYouTubeAPI() {
    const iframes = root.querySelectorAll(YT_IFRAME_SELECTOR);
    if (iframes.length === 0) return;
    
    // Already loaded
    if (window.YT?.Player) {
      initYouTubePlayers();
      return;
    }
    
    // Already loading
    if (window._ytApiLoading) {
      window._ytApiCallbacks = window._ytApiCallbacks || [];
      window._ytApiCallbacks.push(initYouTubePlayers);
      return;
    }
    
    // Start loading
    window._ytApiLoading = true;
    window._ytApiCallbacks = [initYouTubePlayers];
    
    const prevCallback = window.onYouTubeIframeAPIReady;
    window.onYouTubeIframeAPIReady = function() {
      if (prevCallback) prevCallback();
      window._ytApiCallbacks.forEach(cb => cb());
    };
    
    const script = document.createElement('script');
    script.src = 'https://www.youtube.com/iframe_api';
    script.async = true;
    document.head.appendChild(script);
  }

  // ===========================
  // SWIPER INITIALIZATION
  // ===========================
  function initSwiper(el, name) {
    if (!el || !window.Swiper || el.classList.contains('swiper-initialized')) return null;
    
    const autoplay = el.dataset.autoplay === 'true';
    const speed = parseInt(el.dataset.speed) || 5000;
    const showNav = el.dataset.navigation === 'true';
    const showPag = el.dataset.pagination === 'true';
    let direction = el.dataset.direction || 'horizontal';
    
    // Force horizontal on mobile
    if (window.innerWidth < 992) {
      direction = 'horizontal';
    }
    
    // Build selectors based on swiper name
    const isRight = name === 'right';
    const suffix = isRight ? `-right_${SECTION_ID}` : `_${SECTION_ID}`;
    
    const config = {
      slidesPerView: 1,
      loop: false,
      direction,
      autoplay: autoplay ? { delay: speed, disableOnInteraction: false } : false,
      navigation: showNav ? {
        nextEl: `.swiper-button-next${suffix}`,
        prevEl: `.swiper-button-prev${suffix}`,
      } : false,
      pagination: showPag ? {
        el: `.swiper-pagination${isRight ? '-right' : ''}_${SECTION_ID}`,
        clickable: true,
      } : false,
      on: {
        init: function() {
          el.classList.add('ap-object-loaded');
          registerVideosInSwiper(this);
          log(`Swiper ${name} initialized`);
        },
        slideChangeTransitionStart: function() {
          // Stop all videos when navigating
          videoManager.pauseAll();
        },
        slideChangeTransitionEnd: function() {
          // Resume carousel only if no videos are playing
          if (autoplay && !videoManager.isAnyVideoPlaying()) {
            if (!this.autoplay.running) {
              this.autoplay.start();
            }
          }
        }
      }
    };
    
    const swiper = new Swiper(el, config);
    videoManager.registerSwiper(name, swiper);
    
    return swiper;
  }

  function registerVideosInSwiper(swiperInstance) {
    // Register all HTML5 videos
    const videos = swiperInstance.el.querySelectorAll('video');
    videos.forEach(video => {
      videoManager.registerHTML5Video(video);
    });
  }

  // ===========================
  // MAIN INITIALIZATION
  // ===========================
  function init() {
    // Initialize main (left) swiper
    const mainEl = document.querySelector(`#swiper-${SECTION_ID}`);
    if (mainEl) {
      initSwiper(mainEl, 'main');
    }
    
    // Initialize right swiper (if carousel mode)
    const rightEl = document.querySelector(`#swiper-right-${SECTION_ID}`);
    if (rightEl) {
      initSwiper(rightEl, 'right');
    }
    
    // Load YouTube API after Swiper init
    loadYouTubeAPI();
    
    log('Slideshow initialized');
  }

  init();

  // ===========================
  // LIFECYCLE HANDLERS
  // ===========================
  
  // Handle Shopify theme editor reload
  document.addEventListener('shopify:section:load', (e) => {
    if (e.detail.sectionId === SECTION_ID) {
      log('Section reloaded');
      init();
    }
  });

  // Handle responsive breakpoint changes
  let lastWidth = window.innerWidth;
  window.addEventListener('resize', () => {
    const newWidth = window.innerWidth;
    const breakpoint = 992;
    
    if ((lastWidth < breakpoint && newWidth >= breakpoint) ||
        (lastWidth >= breakpoint && newWidth < breakpoint)) {
      
      log('Breakpoint crossed, reinitializing');
      
      // Destroy existing swipers
      Object.values(videoManager.swipers).forEach(swiper => {
        if (swiper) swiper.destroy(true, true);
      });
      videoManager.swipers = { main: null, right: null };
      
      // Clear initialization state
      root.querySelectorAll('.swiper').forEach(el => {
        el.classList.remove('swiper-initialized', 'ap-object-loaded');
      });
      
      // Reinitialize
      init();
    }
    
    lastWidth = newWidth;
  });
});
</script>

{% schema %}
{
  "name": "Slideshow Split",
  "tag": "section",
  "class": "shopify-section--slideshow-split",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": true
    },
    {
      "type": "number",
      "id": "content_width",
      "label": "Content width",
      "default": 1800
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color"
    },
    {
      "type": "text",
      "id": "class",
      "label": "Custom Class"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "desktop_height",
      "min": 200,
      "max": 800,
      "step": 10,
      "unit": "px",
      "label": "Desktop Height",
      "default": 600
    },
    {
      "type": "range",
      "id": "slideshow_width",
      "min": 30,
      "max": 80,
      "step": 5,
      "unit": "%",
      "label": "Slideshow Width (Desktop)",
      "default": 65
    },
    {
      "type": "range",
      "id": "gap",
      "min": 0,
      "max": 50,
      "step": 2,
      "unit": "px",
      "label": "Gap between banners",
      "default": 16
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Border Radius",
      "default": 8
    },
    {
      "type": "select",
      "id": "right_mode",
      "label": "Right Side Layout",
      "options": [
        {
          "value": "stacked",
          "label": "Stacked (2 Static Items)"
        },
        {
          "value": "carousel",
          "label": "Carousel (Slider)"
        }
      ],
      "default": "stacked",
      "info": "Choose 'Stacked' for 2 fixed banners, or 'Carousel' to slide multiple items."
    },
    {
      "type": "select",
      "id": "right_slide_direction",
      "label": "Right Slide Direction (Desktop)",
      "options": [
        {
          "value": "horizontal",
          "label": "Horizontal"
        },
        {
          "value": "vertical",
          "label": "Vertical"
        }
      ],
      "default": "horizontal",
      "info": "Vertical sliding is forced to Horizontal on mobile to prevent scroll issues."
    },
    {
      "type": "select",
      "id": "mobile_aspect_ratio",
      "label": "Mobile Video Aspect Ratio",
      "options": [
        { "value": "auto", "label": "Auto (Natural)" },
        { "value": "16 / 9", "label": "Landscape (16:9)" },
        { "value": "1 / 1", "label": "Square (1:1)" },
        { "value": "4 / 5", "label": "Portrait (4:5)" },
        { "value": "9 / 16", "label": "Full Portrait (9:16)" }
      ],
      "default": "1 / 1",
      "info": "Controls the shape of video slides on mobile."
    },
    {
      "type": "header",
      "content": "Slideshow Settings"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable Slideshow Autoplay",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "autoplay_video",
      "label": "Auto-Play Videos",
      "default": true,
      "info": "If enabled, videos play automatically (muted). If disabled, controls are shown."
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 3,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Autoplay Speed",
      "default": 5
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Show Navigation Arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_pagination",
      "label": "Show Pagination Dots",
      "default": true
    },
    {
      "type": "header",
      "content": "Section Spacing"
    },
    {
      "type": "text",
      "id": "margin_desktop",
      "label": "Margin Desktop",
      "default": "60px 0"
    },
    {
      "type": "text",
      "id": "margin_tablet",
      "label": "Margin Tablet",
      "default": "40px 0"
    },
    {
      "type": "text",
      "id": "margin_mobile",
      "label": "Margin Mobile",
      "default": "30px 0"
    },
    {
      "type": "text",
      "id": "padding_desktop",
      "label": "Padding Desktop"
    },
    {
      "type": "text",
      "id": "padding_tablet",
      "label": "Padding Tablet"
    },
    {
      "type": "text",
      "id": "padding_mobile",
      "label": "Padding Mobile"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Left Slide (Main)",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video (Hosted)",
          "info": "Upload a Shopify-hosted video. Replaces the image if set."
        },
        {
          "type": "video_url",
          "id": "video_url",
          "label": "External Video URL",
          "accept": ["youtube", "vimeo"],
          "info": "YouTube or Vimeo URL. Replaces Image/Hosted Video if set."
        },
        {
          "type": "checkbox",
          "id": "show_controls",
          "label": "Show Video Controls",
          "default": false
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link",
          "info": "Link does not work with videos if controls are enabled."
        }
      ]
    },
    {
      "type": "static_banner",
      "name": "Right Slide (Side)",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video (Hosted)",
          "info": "Upload a Shopify-hosted video. Replaces the image if set. Best for vertical videos."
        },
        {
          "type": "video_url",
          "id": "video_url",
          "label": "External Video URL",
          "accept": ["youtube", "vimeo"],
          "info": "YouTube or Vimeo URL. Replaces Image/Hosted Video if set."
        },
        {
          "type": "checkbox",
          "id": "show_controls",
          "label": "Show Video Controls",
          "default": false
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link",
          "info": "Link does not work with videos if controls are enabled."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Slideshow Split",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" },
        { "type": "static_banner" },
        { "type": "static_banner" }
      ]
    }
  ]
}
{% endschema %}
