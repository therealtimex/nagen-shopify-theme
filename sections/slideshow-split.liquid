{%- style -%}
  #shopify-section-{{ section.id }} {
    --slideshow-width: {{ section.settings.slideshow_width }}%;
    --gap: {{ section.settings.gap }}px;
    --border-radius: {{ section.settings.border_radius }}px;
    --desktop-height: {{ section.settings.desktop_height }}px;
    --mobile-aspect-ratio: {{ section.settings.mobile_aspect_ratio }};
  }

  .slideshow-split__container {
    display: flex;
    gap: var(--gap);
    align-items: stretch;
    width: 100%;
  }

  .slideshow-split__main {
    width: var(--slideshow-width);
    flex-shrink: 0;
    position: relative;
    border-radius: var(--border-radius);
    overflow: hidden;
    height: var(--desktop-height) !important;
  }

  .slideshow-split__static {
    width: calc(100% - var(--slideshow-width) - var(--gap));
    display: flex;
    flex-direction: column;
    gap: var(--gap);
    flex-grow: 1;
    height: var(--desktop-height) !important;
  }

  .slideshow-split__static-item {
    flex: 1;
    position: relative;
    border-radius: var(--border-radius);
    overflow: hidden;
    height: 100%;
  }

  .slideshow-split__image-link {
    display: block;
    width: 100%;
    height: 100%;
  }

  .slideshow-split__image-link img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  /* Swiper Customization */
  .slideshow-split .swiper {
    width: 100% !important;
    height: 100% !important;
    position: relative;
  }

  .slideshow-split .swiper-wrapper {
    height: 100% !important;
  }

  .slideshow-split .swiper-slide {
    height: 100% !important;
  }

  .slideshow-split .swiper-pagination {
    bottom: 20px !important;
    left: 50% !important;
    transform: translateX(-50%);
    width: auto !important;
    z-index: 10;
    display: flex !important;
    gap: 8px;
  }

  .slideshow-split .swiper-pagination-bullet {
    background: #fff !important;
    opacity: 0.6 !important;
    width: 10px !important;
    height: 10px !important;
    margin: 0 !important;
    transition: all 0.3s ease;
    border-radius: 50%;
    cursor: pointer;
    display: block !important;
  }

  .slideshow-split .swiper-pagination-bullet-active {
    background: var(--primary, #21395d) !important;
    opacity: 1 !important;
    width: 25px !important;
    border-radius: 5px !important;
  }

  .slideshow-split .swiper-button-next,
  .slideshow-split .swiper-button-prev {
    color: #fff;
    background: rgba(0,0,0,0.3); /* Slightly darker for visibility */
    width: 44px;
    height: 44px; /* Larger touch target */
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex; /* Ensure always visible if enabled */
    align-items: center;
    justify-content: center;
    z-index: 20;
  }

  .slideshow-split .swiper-button-next:hover,
  .slideshow-split .swiper-button-prev:hover {
    background: rgba(0,0,0,0.6);
    transform: scale(1.1); /* Visual cue on hover */
  }

  .slideshow-split .swiper-button-next:after,
  .slideshow-split .swiper-button-prev:after {
    font-size: 18px;
  }

  @media (max-width: 991px) {
    .slideshow-split__main,
    .slideshow-split__static {
      height: auto !important;
    }
    .slideshow-split__container {
      flex-direction: column;
    }
    .slideshow-split__main,
    .slideshow-split__static {
      width: 100%;
    }
    .slideshow-split__static {
      flex-direction: row;
    }
    .slideshow-split__main {
      aspect-ratio: 16 / 8;
    }
    /* Fix mobile height for static side - allow vertical growth */
    .slideshow-split__static-item {
      aspect-ratio: auto;
      min-aspect-ratio: 16 / 8;
      height: auto !important;
    }
    .slideshow-split .swiper-slide {
      height: auto !important; /* Allow slides to grow on mobile */
    }
    /* Mobile Video Fix: Force square/portrait ratio to prevent collapse */
    .slideshow-split__static-item--video {
      aspect-ratio: var(--mobile-aspect-ratio) !important;
      min-height: 0;
      height: auto !important;
      display: block;
      width: 100%;
      object-fit: cover;
    }
    /* Ensure video facade respects the new aspect ratio logic */
     .slideshow-split__video-container {
      height: 100% !important;
    }
    
    .slideshow-split .swiper-pagination {
      bottom: 10px !important;
    }
  }

  @media (max-width: 575px) {
    .slideshow-split__static {
      flex-direction: column;
    }
  }
  .slideshow-split__video-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  .slideshow-split__video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none; /* Default: no interaction for bg video */
  }

  .slideshow-split__video--controls {
    pointer-events: auto; /* Enable controls if requested */
  }

  .slideshow-split__video iframe {
    width: 100%;
    height: 100%;
    position: absolute;
    top: 0;
    left: 0;
  }
{%- endstyle -%}

{% render 'section-style' %}

<section class="section section--flush shopify-section--slideshow slideshow-split {{ section.settings.class }}" data-section-id="{{ section.id }}">
  <div class="shopify-container">
    <div class="slideshow-split__container">
      
      {%- assign slide_blocks = section.blocks | where: 'type', 'slide' -%}
      {%- if slide_blocks.size > 0 -%}
        <div class="slideshow-split__main">
          <div id="swiper-{{ section.id }}" class="slideshow swiper ap-object-loaded" 
            data-autoplay="{{ section.settings.autoplay }}"
            data-speed="{{ section.settings.autoplay_speed | times: 1000 }}"
            data-navigation="{{ section.settings.show_navigation }}"
            data-pagination="{{ section.settings.show_pagination }}">
            
            <div class="swiper-wrapper">
              {%- for block in slide_blocks -%}
                <div class="swiper-slide" {{ block.shopify_attributes }}>
                  {%- if block.settings.video != blank -%}
                    <div class="slideshow-split__video-container">
                      {{ block.settings.video | video_tag: 
                        image_size: '2000x', 
                        autoplay: section.settings.autoplay_video, 
                        loop: section.settings.autoplay_video, 
                        muted: section.settings.autoplay_video, 
                        controls: block.settings.show_controls,
                        class: 'slideshow-split__video' 
                      }}
                    </div>
                  {%- elsif block.settings.video_url != blank -%}
                    <div class="slideshow-split__video-container">
                      {%- if block.settings.video_url.type == 'youtube' -%}
                        <iframe src="https://www.youtube.com/embed/{{ block.settings.video_url.id }}?autoplay={% if section.settings.autoplay_video %}1{% else %}0{% endif %}&mute={% if section.settings.autoplay_video %}1{% else %}0{% endif %}&loop={% if section.settings.autoplay_video %}1{% else %}0{% endif %}&playlist={{ block.settings.video_url.id }}&controls={{ block.settings.show_controls | default: 0 }}&playsinline=1&rel=0" class="slideshow-split__video" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                      {%- elsif block.settings.video_url.type == 'vimeo' -%}
                         <iframe src="https://player.vimeo.com/video/{{ block.settings.video_url.id }}?autoplay={% if section.settings.autoplay_video %}1{% else %}0{% endif %}&muted={% if section.settings.autoplay_video %}1{% else %}0{% endif %}&loop={% if section.settings.autoplay_video %}1{% else %}0{% endif %}&background=1" class="slideshow-split__video" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>
                      {%- endif -%}
                    </div>
                  {%- else -%}
                    {%- if block.settings.link != blank -%}
                      <a href="{{ block.settings.link }}" class="slideshow-split__image-link">
                    {%- else -%}
                      <div class="slideshow-split__image-link">
                    {%- endif -%}
                      
                      {%- if block.settings.image != blank -%}
                        {{ block.settings.image | image_url: width: 2000 | image_tag: loading: 'lazy', class: 'slideshow-split__image' }}
                      {%- else -%}
                        {{ 'lifestyle-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      {%- endif -%}

                    {%- if block.settings.link != blank -%}
                      </a>
                    {%- else -%}
                      </div>
                    {%- endif -%}
                  {%- endif -%}
                </div>
              {%- endfor -%}
            </div>

            {%- if section.settings.show_pagination -%}
              <div class="swiper-pagination swiper-pagination_{{ section.id }}"></div>
            {%- endif -%}

            {%- if section.settings.show_navigation -%}
              <div class="swiper-button-prev swiper-button-prev_{{ section.id }}"></div>
              <div class="swiper-button-next swiper-button-next_{{ section.id }}"></div>
            {%- endif -%}
          </div>
        </div>
      {%- endif -%}

      {%- assign static_blocks = section.blocks | where: 'type', 'static_banner' -%}
      {%- if static_blocks.size > 0 -%}
        <div class="slideshow-split__static">
          
          {%- if section.settings.right_mode == 'carousel' -%}
            <!-- Carousel Mode (Right Side) -->
            <div id="swiper-right-{{ section.id }}" class="slideshow swiper ap-object-loaded" 
              data-autoplay="{{ section.settings.autoplay }}"
              data-speed="{{ section.settings.autoplay_speed | times: 1000 }}"
              data-navigation="{{ section.settings.show_navigation }}"
              data-pagination="{{ section.settings.show_pagination }}"
              data-direction="{{ section.settings.right_slide_direction }}">
              
              <div class="swiper-wrapper">
                {%- for block in static_blocks -%}
                  {%- liquid
                    assign has_video = false
                    if block.settings.video != blank or block.settings.video_url != blank
                      assign has_video = true
                    endif
                  -%}
                  <div class="swiper-slide {% if has_video %}slideshow-split__static-item--video{% endif %}" {{ block.shopify_attributes }}>
                    {%- render 'slideshow-split-content', block: block, autoplay_video: section.settings.autoplay_video -%}
                  </div>
                {%- endfor -%}
              </div>

              {%- if section.settings.show_pagination -%}
                <div class="swiper-pagination swiper-pagination-right_{{ section.id }}"></div>
              {%- endif -%}

              {%- if section.settings.show_navigation -%}
                <div class="swiper-button-prev swiper-button-prev-right_{{ section.id }}"></div>
                <div class="swiper-button-next swiper-button-next-right_{{ section.id }}"></div>
              {%- endif -%}
            </div>

          {%- else -%}
            <!-- Stacked Mode (Legacy 2 items) -->
            {%- for block in static_blocks limit: 2 -%}
              {%- liquid
                assign has_video = false
                if block.settings.video != blank or block.settings.video_url != blank
                  assign has_video = true
                endif
              -%}
              <div class="slideshow-split__static-item {% if has_video %}slideshow-split__static-item--video{% endif %}" {{ block.shopify_attributes }}>
                {%- render 'slideshow-split-content', block: block, autoplay_video: section.settings.autoplay_video -%}
              </div>
            {%- endfor -%}
          {%- endif -%}

        </div>
      {%- endif -%}

    </div>
  </div>
</section>

{%- capture content_snippet -%}
{%- endcapture -%}

<script>
  document.addEventListener('DOMContentLoaded', function() {
    let mainSwiper, rightSwiper;

    const initSwiperSplit = () => {
      // 1. Initialize Main Swiper (Left)
      const elMain = document.querySelector('#swiper-{{ section.id }}');
      if (elMain && window.Swiper && !elMain.classList.contains('swiper-initialized')) {
        mainSwiper = initSingleSwiper(elMain, '{{ section.id }}');
      }

      // 2. Initialize Right Swiper (if in Carousel Mode)
      const elRight = document.querySelector('#swiper-right-{{ section.id }}');
      if (elRight && window.Swiper && !elRight.classList.contains('swiper-initialized')) {
        rightSwiper = initSingleSwiper(elRight, 'right_{{ section.id }}');
      }
    };

    const initSingleSwiper = (el, uniqueKey) => {
      const autoplay = el.dataset.autoplay === 'true';
      const speed = parseInt(el.dataset.speed) || 5000;
      const showNav = el.dataset.navigation === 'true';
      const showPag = el.dataset.pagination === 'true';
      let direction = el.dataset.direction || 'horizontal';

      // Force horizontal on mobile to prevent scroll hijacking
      if (window.innerWidth < 992) {
        direction = 'horizontal';
      }

      let nextEl, prevEl, pagEl;

      if (uniqueKey.startsWith('right_')) {
        nextEl = `.swiper-button-next-${uniqueKey}`;
        prevEl = `.swiper-button-prev-${uniqueKey}`;
        pagEl = `.swiper-pagination-${uniqueKey}`;
      } else {
        nextEl = `.swiper-button-next_${uniqueKey}`;
        prevEl = `.swiper-button-prev_${uniqueKey}`;
        pagEl = `.swiper-pagination_${uniqueKey}`;
      }

      return new Swiper(el, {
        slidesPerView: 1,
        loop: true,
        direction: direction,
        autoplay: autoplay ? { delay: speed, disableOnInteraction: false } : false,
        navigation: showNav ? {
          nextEl: nextEl,
          prevEl: prevEl,
        } : false,
        pagination: showPag ? {
          el: pagEl,
          clickable: true,
          bulletClass: 'swiper-pagination-bullet',
          bulletActiveClass: 'swiper-pagination-bullet-active',
        } : false,
        on: {
          init: function() {
            el.classList.add('ap-object-loaded');
          }
        }
      });
    }

    initSwiperSplit();
    document.addEventListener('shopify:section:load', initSwiperSplit);

    // Re-check direction on resize
    let lastWidth = window.innerWidth;
    window.addEventListener('resize', () => {
       const newWidth = window.innerWidth;
       const breakpoint = 992;
       
       // Reload instances if crossing breakpoint (Vertical <-> Horizontal switch)
       if ((lastWidth < breakpoint && newWidth >= breakpoint) || 
           (lastWidth >= breakpoint && newWidth < breakpoint)) {
         
         if (mainSwiper) mainSwiper.destroy(true, true);
         if (rightSwiper) rightSwiper.destroy(true, true);
         
         // Cleanup classes
         document.querySelectorAll('.slideshow-split .swiper').forEach(el => el.classList.remove('swiper-initialized', 'ap-object-loaded'));
         
         initSwiperSplit();
       }
       lastWidth = newWidth;
    });
  });
</script>

{% schema %}
{
  "name": "Slideshow Split",
  "tag": "section",
  "class": "shopify-section--slideshow-split",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": true
    },
    {
      "type": "number",
      "id": "content_width",
      "label": "Content width",
      "default": 1800
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color"
    },
    {
      "type": "text",
      "id": "class",
      "label": "Custom Class"
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "desktop_height",
      "min": 200,
      "max": 800,
      "step": 10,
      "unit": "px",
      "label": "Desktop Height",
      "default": 600
    },
    {
      "type": "range",
      "id": "slideshow_width",
      "min": 30,
      "max": 80,
      "step": 5,
      "unit": "%",
      "label": "Slideshow Width (Desktop)",
      "default": 65
    },
    {
      "type": "range",
      "id": "gap",
      "min": 0,
      "max": 50,
      "step": 2,
      "unit": "px",
      "label": "Gap between banners",
      "default": 16
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Border Radius",
      "default": 8
    },
    {
      "type": "select",
      "id": "right_mode",
      "label": "Right Side Layout",
      "options": [
        {
          "value": "stacked",
          "label": "Stacked (2 Static Items)"
        },
        {
          "value": "carousel",
          "label": "Carousel (Slider)"
        }
      ],
      "default": "stacked",
      "info": "Choose 'Stacked' for 2 fixed banners, or 'Carousel' to slide multiple items."
    },
    {
      "type": "select",
      "id": "right_slide_direction",
      "label": "Right Slide Direction (Desktop)",
      "options": [
        {
          "value": "horizontal",
          "label": "Horizontal"
        },
        {
          "value": "vertical",
          "label": "Vertical"
        }
      ],
      "default": "horizontal",
      "info": "Vertical sliding is forced to Horizontal on mobile to prevent scroll issues."
    },
    {
      "type": "select",
      "id": "mobile_aspect_ratio",
      "label": "Mobile Video Aspect Ratio",
      "options": [
        { "value": "auto", "label": "Auto (Natural)" },
        { "value": "16 / 9", "label": "Landscape (16:9)" },
        { "value": "1 / 1", "label": "Square (1:1)" },
        { "value": "4 / 5", "label": "Portrait (4:5)" },
        { "value": "9 / 16", "label": "Full Portrait (9:16)" }
      ],
      "default": "1 / 1",
      "info": "Controls the shape of video slides on mobile."
    },
    {
      "type": "header",
      "content": "Slideshow Settings"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Enable Slideshow Autoplay",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "autoplay_video",
      "label": "Auto-Play Videos",
      "default": true,
      "info": "If enabled, videos play automatically (muted). If disabled, controls are shown."
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 3,
      "max": 10,
      "step": 1,
      "unit": "s",
      "label": "Autoplay Speed",
      "default": 5
    },
    {
      "type": "checkbox",
      "id": "show_navigation",
      "label": "Show Navigation Arrows",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_pagination",
      "label": "Show Pagination Dots",
      "default": true
    },
    {
      "type": "header",
      "content": "Section Spacing"
    },
    {
      "type": "text",
      "id": "margin_desktop",
      "label": "Margin Desktop",
      "default": "60px 0"
    },
    {
      "type": "text",
      "id": "margin_tablet",
      "label": "Margin Tablet",
      "default": "40px 0"
    },
    {
      "type": "text",
      "id": "margin_mobile",
      "label": "Margin Mobile",
      "default": "30px 0"
    },
    {
      "type": "text",
      "id": "padding_desktop",
      "label": "Padding Desktop"
    },
    {
      "type": "text",
      "id": "padding_tablet",
      "label": "Padding Tablet"
    },
    {
      "type": "text",
      "id": "padding_mobile",
      "label": "Padding Mobile"
    }
  ],
  "blocks": [
    {
      "type": "slide",
      "name": "Left Slide (Main)",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video (Hosted)",
          "info": "Upload a Shopify-hosted video. Replaces the image if set."
        },
        {
          "type": "video_url",
          "id": "video_url",
          "label": "External Video URL",
          "accept": ["youtube", "vimeo"],
          "info": "YouTube or Vimeo URL. Replaces Image/Hosted Video if set."
        },
        {
          "type": "checkbox",
          "id": "show_controls",
          "label": "Show Video Controls",
          "default": false
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link",
          "info": "Link does not work with videos if controls are enabled."
        }
      ]
    },
    {
      "type": "static_banner",
      "name": "Right Slide (Side)",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video (Hosted)",
          "info": "Upload a Shopify-hosted video. Replaces the image if set. Best for vertical videos."
        },
        {
          "type": "video_url",
          "id": "video_url",
          "label": "External Video URL",
          "accept": ["youtube", "vimeo"],
          "info": "YouTube or Vimeo URL. Replaces Image/Hosted Video if set."
        },
        {
          "type": "checkbox",
          "id": "show_controls",
          "label": "Show Video Controls",
          "default": false
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link",
          "info": "Link does not work with videos if controls are enabled."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Slideshow Split",
      "blocks": [
        { "type": "slide" },
        { "type": "slide" },
        { "type": "static_banner" },
        { "type": "static_banner" }
      ]
    }
  ]
}
{% endschema %}
