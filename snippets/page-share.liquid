{% comment %}
  Page Share Snippet
  Renders social share buttons and a "Copy Link" button.
  Automatically appends affiliate code if available via window.affiliateTracker.

  Usage:
  {% render 'page-share' %}
{% endcomment %}

<div class="page-share">
  <div class="page-share__label">{{ 'general.share.share_url' | t | default: 'Chia sẻ' }}</div>
  
  <div class="page-share__list">
    {%- assign share_url = shop.url | append: page.url -%}
    {%- assign share_title = page.title | url_param_escape -%}
    
    {%- comment -%} Facebook {%- endcomment -%}
    <a class="page-share__item page-share__item--facebook" 
       href="//www.facebook.com/sharer.php?u={{ share_url }}" 
       target="_blank" 
       rel="noopener" 
       aria-label="Share on Facebook"
       data-share-url="{{ share_url }}">
      <svg class="icon icon--facebook" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </a>

    {%- comment -%} X (formerly Twitter) {%- endcomment -%}
    <a class="page-share__item page-share__item--x" 
       href="//twitter.com/share?text={{ share_title }}&url={{ share_url }}" 
       target="_blank" 
       rel="noopener" 
       aria-label="Share on X"
       data-share-url="{{ share_url }}">
      <svg class="icon icon--x" width="24" height="24" viewBox="0 0 30 30" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M26.37,26l-8.795-12.822l0.015,0.012L25.52,4h-2.65l-6.46,7.48L11.28,4H4.33l8.211,11.971L12.54,15.97L3.88,26h2.65 l7.182-8.322L19.42,26H26.37z M10.23,6l12.34,18h-2.1L8.12,6H10.23z" fill="currentColor"/>
      </svg>
    </a>

    {%- comment -%} Email {%- endcomment -%}
    <a class="page-share__item page-share__item--email" 
       href="mailto:?subject={{ share_title }}&body={{ share_url }}" 
       aria-label="Share by Email"
       data-share-url="{{ share_url }}">
      <svg class="icon icon--email" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <polyline points="22,6 12,13 2,6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </a>

    {%- comment -%} Copy Link {%- endcomment -%}
    <button class="page-share__item page-share__item--copy" 
            type="button" 
            aria-label="Copy Link"
            title="Copy Link"
            onclick="copyPageLink(this)">
      <svg class="icon icon--copy" width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <span class="page-share__tooltip">Đã sao chép!</span>
    </button>
  </div>
</div>

<script>
  function copyPageLink(button) {
    let url = window.location.href;
    
    // Append affiliate code if available
    if (window.affiliateTracker && typeof window.affiliateTracker.getAffiliateRef === 'function') {
      const ref = window.affiliateTracker.getAffiliateRef();
      if (ref) {
        // Use the tracker's decorateUrl method if available, or manual append
        if (typeof window.affiliateTracker.decorateUrl === 'function') {
          url = window.affiliateTracker.decorateUrl(url, ref);
        } else {
          const separator = url.includes('?') ? '&' : '?';
          const paramName = window.affiliateTracker.paramName || 'ref';
          url = `${url}${separator}${paramName}=${encodeURIComponent(ref)}`;
        }
      }
    }

    navigator.clipboard.writeText(url).then(() => {
      // Show tooltip
      button.classList.add('copied');
      setTimeout(() => {
        button.classList.remove('copied');
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy: ', err);
    });
  }
</script>
